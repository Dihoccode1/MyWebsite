<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>L·ªãch s·ª≠ ƒë∆°n h√†ng</title>
  <link rel="stylesheet" href="/bootstrap-4.6.2-dist/css/bootstrap.css">
  <link rel="stylesheet" href="/assets/css/base.css">
  <link rel="stylesheet" href="/assets/css/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body>
<header class="header">
  <div class="topbar">
    <div class="container">
      <div class="topbar-right"></div>
    </div>
  </div>
</header>

<header class="mid-header">
  <div class="container">
    <div class="header-main">
      <div class="header-left">
        <!-- Ch·∫∑n autofill & g√µ d·∫•u ok -->
        <form action="/search" method="get" class="search-bar" autocomplete="off">
          <input type="text" name="query" placeholder="T√¨m ki·∫øm"
                 autocomplete="off" autocapitalize="off" autocorrect="off"
                 spellcheck="false" inputmode="search" />
          <button type="submit" aria-label="T√¨m ki·∫øm">
            <i class="fa-solid fa-magnifying-glass"></i>
          </button>
        </form>
      </div>

      <div class="header-center">
        <a href="/trangchu.html" class="logo">
          <img src="/assets/images/logo.jpg" alt="GENTLEMAN">
        </a>
      </div>

      <div class="header-right">
        <a href="/giohang.html" class="cart-link">
          <i class="fa-solid fa-cart-shopping"></i>
          GI·ªé H√ÄNG (<span class="cart-count">0</span>)
        </a>
      </div>
    </div>
  </div>
</header>

<nav class="main-nav">
  <ul>
    <li><a href="/trangchu.html">TRANG CH·ª¶</a></li>
    <li><a href="/gioithieu.html">GI·ªöI THI·ªÜU</a></li>
    <li><a href="/sanpham/sanpham.html" class="js-products-url">S·∫¢N PH·∫®M</a></li>
    <li><a href="/tintuc.html">TIN T·ª®C</a></li>
    <li><a href="/lienhe.html">LI√äN H·ªÜ</a></li>
  </ul>
</nav>

<script>
(function (w, d) {
  function getProductsURL() {
    var a = d.querySelector('nav.main-nav a.js-products-url')
          || d.querySelector('nav.main-nav a[href*="/sanpham"]');
    return (a && a.getAttribute('href')) ? a.getAttribute('href') : '/sanpham/sanpham.html';
  }

  var form = d.querySelector('.search-bar');
  if (!form) return;

  form.addEventListener('submit', function (e) {
    e.preventDefault();
    var input = form.querySelector('input[name="query"], input[name="q"]');
    var q = (input && input.value || '').trim().replace(/\s+/g, ' ');
    var raw = getProductsURL();
    var url = new URL(raw, w.location.origin);
    if (q) url.searchParams.set('q', q); else url.searchParams.delete('q');
    w.location.href = url.pathname + (url.search ? url.search : '');
  }, { passive: false });
})(window, document);
</script>
<script>
(function (w, d) {
  function makeWelcomeClickable() {
    var el = d.querySelector('.welcome-user');
    if (el) { el.setAttribute('href', '/account/profile.html'); return; }
    var target = d.querySelector('#welcomeName, [data-welcome-name], .js-welcome-name');
    if (!target) return;
    if (target.tagName !== 'A') {
      var a = d.createElement('a');
      a.href = '/account/profile.html';
      a.className = 'welcome-link';
      while (target.firstChild) a.appendChild(target.firstChild);
      target.appendChild(a);
    } else {
      target.setAttribute('href', '/account/profile.html');
    }
  }
  d.addEventListener('auth:ready', makeWelcomeClickable);
  if (w.AUTH && w.AUTH.ready) makeWelcomeClickable();
})(window, document);
</script>

<div class="container py-4">
  <h3 class="mb-3">L·ªãch s·ª≠ mua h√†ng</h3>

  <div class="form-inline mb-3">
    <label class="mr-2">Email t√†i kho·∫£n</label>
    <input id="accEmail" class="form-control mr-2" style="min-width:260px" placeholder="nh·∫≠p email ƒë·ªÉ tra ƒë∆°n">
    <button id="btnLoad" class="btn btn-secondary">T·∫£i</button>
  </div>

  <div id="ordersWrap"></div>
</div>

<footer class="footer">
  <div class="site-footer">
    <div class="top-footer">
      <div class="container">
        <div class="row">
          <section class="widget-ft">
            <h4 class="title-menu">Th√¥ng tin</h4>
            <ul class="list-menu">
              <li class="li_menu"><a href="/trangchu.html">Trang ch·ªß</a></li>
              <li class="li_menu"><a href="/gioithieu.html">Gi·ªõi thi·ªáu</a></li>
              <li class="li_menu"><a href="/sanpham/sanpham.html">S·∫£n ph·∫©m</a></li>
              <li class="li_menu"><a href="/tintuc.html">Tin t·ª©c</a></li>
              <li class="li_menu"><a href="/lienhe.html">Li√™n h·ªá</a></li>
            </ul>
          </section>

          <section class="widget-ft">
            <h4 class="title-menu">H·ªó tr·ª£</h4>
            <ul class="list-menu">
              <li class="li_menu"><a href="/trangchu.html">Trang ch·ªß</a></li>
              <li class="li_menu"><a href="/gioithieu.html">Gi·ªõi thi·ªáu</a></li>
              <li class="li_menu"><a href="/sanpham/sanpham.html">S·∫£n ph·∫©m</a></li>
              <li class="li_menu"><a href="/tintuc.html">Tin t·ª©c</a></li>
              <li class="li_menu"><a href="/lienhe.html">Li√™n h·ªá</a></li>
            </ul>
          </section>

          <section class="widget-ft">
            <h4 class="title-menu">H∆∞·ªõng d·∫´n</h4>
            <ul class="list-menu">
              <li class="li_menu"><a href="/trangchu.html">Trang ch·ªß</a></li>
              <li class="li_menu"><a href="/gioithieu.html">Gi·ªõi thi·ªáu</a></li>
              <li class="li_menu"><a href="/sanpham/sanpham.html">S·∫£n ph·∫©m</a></li>
              <li class="li_menu"><a href="/tintuc.html">Tin t·ª©c</a></li>
              <li class="li_menu"><a href="/lienhe.html">Li√™n h·ªá</a></li>
            </ul>
          </section>

          <section class="widget-ft">
            <h4 class="title-menu">Ch√≠nh s√°ch</h4>
            <ul class="list-menu">
              <li class="li_menu"><a href="/trangchu.html">Trang ch·ªß</a></li>
              <li class="li_menu"><a href="/gioithieu.html">Gi·ªõi thi·ªáu</a></li>
              <li class="li_menu"><a href="/sanpham/sanpham.html">S·∫£n ph·∫©m</a></li>
              <li class="li_menu"><a href="/tintuc.html">Tin t·ª©c</a></li>
              <li class="li_menu"><a href="/lienhe.html">Li√™n h·ªá</a></li>
            </ul>
          </section>

          <section class="wg-logo">
            <h4 class="title-menu">Li√™n h·ªá</h4>
            <ul class="contact">
              <li>
                <span class="txt_content_child">
                  <span><i class="fa-solid fa-location-dot" aria-hidden="true"></i></span>
                  140B-T·ªï 3, ·∫§p X√≥m Ch√πa, T·ªânh T√¢y Ninh
                </span>
              </li>
              <li class="sdt">
                <span><i class="fa-solid fa-phone" aria-hidden="true"></i></span>
                <a href="tel:0338286525">0338286525</a>
              </li>
              <li class="sdt">
                <span><i class="fa-solid fa-envelope"></i></span>
                <a href="mailto:thanhloc29052006@gmail.com">thanhloc29052006@gmail.com</a>
              </li>
            </ul>
          </section>
        </div>
      </div>
    </div>

    <div class="mid-footer">
      <div class="container">
        <div class="row">
          <div class="fot_copyright">
            <span class="wsp"><span>Cung c·∫•p b·ªüi <a href="javascript:;">Nh√≥m 7</a></span></span>
          </div>
          <nav class="fot_menu_copyright">
            <ul class="ul_menu_fot">
              <li><a href="/trangchu.html" title="Trang ch·ªß">Trang ch·ªß</a></li>
              <li><a href="/gioithieu.html" title="Gi·ªõi thi·ªáu">Gi·ªõi thi·ªáu</a></li>
              <li><a href="/sanpham/sanpham.html" title="S·∫£n ph·∫©m">S·∫£n ph·∫©m</a></li>
              <li><a href="/tin-tuc.html" title="Tin t·ª©c">Tin t·ª©c</a></li>
              <li><a href="/lienhe.html" title="Li√™n h·ªá">Li√™n h·ªá</a></li>
            </ul>
          </nav>
          <div class="pay_footer">
            <ul class="follow_option">
              <li><a href="#"><img src="//bizweb.dktcdn.net/100/004/366/themes/900241/assets/pay_1.png" alt="Payment"></a></li>
              <li><a href="#"><img src="//bizweb.dktcdn.net/100/004/366/themes/900241/assets/pay_2.png" alt="Payment"></a></li>
              <li><a href="#"><img src="//bizweb.dktcdn.net/100/004/366/themes/900241/assets/pay_3.png" alt="Payment"></a></li>
              <li><a href="#"><img src="//bizweb.dktcdn.net/100/004/366/themes/900241/assets/pay_4.png" alt="Payment"></a></li>
              <li><a href="#"><img src="//bizweb.dktcdn.net/100/004/366/themes/900241/assets/pay_5.png" alt="Payment"></a></li>
              <li><a href="#"><img src="//bizweb.dktcdn.net/100/004/366/themes/900241/assets/pay_6.png" alt="Payment"></a></li>
              <li><a href="#"><img src="//bizweb.dktcdn.net/100/004/366/themes/900241/assets/pay_7.png" alt="Payment"></a></li>
            </ul>
          </div>
          <a href="#" id="back-to-top" class="backtop" title="L√™n ƒë·∫ßu trang">
            <i class="fa-solid fa-angle-up" aria-hidden="true"></i>
          </a>
        </div>
      </div>
    </div>
  </div>
</footer>

<!-- Auth + Data + Store -->
<script src="/assets/js/auth.js"></script>
<script src="/assets/js/auth.security.enforcer.js"></script>
<script src="/assets/js/auth.localstorage.bridge.js"></script>
<script src="/assets/js/auth.reactive.guard.v2.js"></script>
<script src="/assets/js/auth.modal.bridge.js"></script>
<script src="/assets/js/products.seed.js"></script>
<script src="/assets/js/store.js"></script>
<script src="/assets/js/ui.js"></script>

<script>
/* L·ªãch s·ª≠ ƒë∆°n h√†ng ‚Äì localStorage demo
   ƒê·ªçc t·ª´ localStorage['sv_orders_v1'] = { email: [order,‚Ä¶] }
*/
(function(){
  const KEY = 'sv_orders_v1';
  const $ = s => document.querySelector(s);
  const ordersWrap = $('#ordersWrap');
  const accEmail   = $('#accEmail');
  const money = n => (Number(n)||0).toLocaleString('vi-VN') + '‚Ç´';

  /* ===== Map ti·∫øng Vi·ªát cho status & payment (ch·ªâ HI·ªÇN TH·ªä) ===== */
  const STATUS_TEXT = {
    new:        'M·ªõi',
    confirmed:  'ƒê√£ x√°c nh·∫≠n',
    shipping:   'ƒêang giao',
    delivered:  'ƒê√£ giao',
    cancelled:  'ƒê√£ h·ªßy'
  };
  const STATUS_BADGE = {
    new:        'badge-secondary',
    confirmed:  'badge-info',
    shipping:   'badge-warning',
    delivered:  'badge-success',
    cancelled:  'badge-danger'
  };
  const PAY_TEXT = {
    COD:    'Ti·ªÅn m·∫∑t khi nh·∫≠n (COD)',
    BANK:   'Chuy·ªÉn kho·∫£n',
    ONLINE: 'Thanh to√°n tr·ª±c tuy·∫øn'
  };

  // T·ª± ƒëi·ªÅn email t·ª´ h·ªá auth n·∫øu c√≥
  document.addEventListener('auth:ready', fillEmailFromAuth);
  if (window.AUTH && window.AUTH.ready) fillEmailFromAuth();

  function fillEmailFromAuth(){
    if (window.AUTH?.loggedIn && window.AUTH.user?.email) {
      accEmail.value = window.AUTH.user.email;
      load();
    }
  }

  function load(){
    const email = (accEmail.value||'').trim().toLowerCase();
    if (!email) { alert('Nh·∫≠p email t√†i kho·∫£n'); return; }
    const db = JSON.parse(localStorage.getItem(KEY)||'{}');
    const list = Array.isArray(db[email]) ? db[email] : [];
    ordersWrap.innerHTML = list.length ? list.map(renderCard).join('') : '<div class="text-muted">Ch∆∞a c√≥ ƒë∆°n h√†ng.</div>';
  }

  function renderCard(o){
    const date = new Date(o.created_at);
    const when = isNaN(date) ? (o.created_at||'') : date.toLocaleString('vi-VN');
    const ship = [o.shipping?.address, o.shipping?.district, o.shipping?.city].filter(Boolean).join(', ');

    const stKey    = String(o.status||'new').toLowerCase();
    const stLabel  = STATUS_TEXT[stKey] || 'M·ªõi';
    const stBadge  = STATUS_BADGE[stKey] || 'badge-secondary';
    const payLabel = PAY_TEXT[String(o.payMethod||'').toUpperCase()] || '';

    const items = (o.items||[]).map(it => `
      <li class="list-group-item d-flex justify-content-between">
        <div>${escapeHtml(it.name)} <span class="text-muted">x${Number(it.qty)||0}</span></div>
        <div>${money((Number(it.price)||0) * (Number(it.qty)||0))}</div>
      </li>
    `).join('');

    return `
      <div class="card mb-3">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">ƒê∆°n ${escapeHtml(o.id||'‚Äî')}</h5>
            <span class="badge ${stBadge}">${escapeHtml(stLabel)}</span>
          </div>
          <div class="text-muted mb-2">${escapeHtml(when)}${payLabel ? ' ‚Ä¢ ' + escapeHtml(payLabel) : ''}</div>
          <div class="mb-2">
            <strong>Giao ƒë·∫øn:</strong>
            ${escapeHtml(o.shipping?.fullname||'')} ‚Ä¢ ${escapeHtml(o.shipping?.phone||'')}<br>
            ${escapeHtml(ship)}
          </div>
          <ul class="list-group list-group-flush mb-2">${items}</ul>
          <div class="d-flex justify-content-between mt-2">
            <span>T·∫°m t√≠nh</span><strong>${money(o.subtotal)}</strong>
          </div>
          <div class="d-flex justify-content-between">
            <span>Ph√≠ v·∫≠n chuy·ªÉn</span><strong>${money(o.ship)}</strong>
          </div>
          <hr>
          <div class="d-flex justify-content-between">
            <span>T·ªïng c·ªông</span><strong>${money(o.total)}</strong>
          </div>
        </div>
      </div>`;
  }

  function escapeHtml(s){
    return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  // n√∫t t·∫£i
  document.getElementById('btnLoad').addEventListener('click', load);
  window.UserOrdersReload = load; 
})();
</script>

<script>
/* Bridge: {email:[orders]} -> flat array cho Admin + bump */
(function(){
  const SRC = 'sv_orders_v1';
  const DST = 'sv_orders_flat';
  const BUMP = 'orders.bump';

  function flatten(){
    try{
      const raw = JSON.parse(localStorage.getItem(SRC) || '{}');
      const list = Array.isArray(raw) ? raw : Object.values(raw||{}).flat();
      localStorage.setItem(DST, JSON.stringify(list || []));
      localStorage.setItem(BUMP, String(Date.now())); // üîî b√°o cho Admin
    }catch(e){ console.warn('Bridge flatten error:', e); }
  }

  // ch·∫°y l√∫c v√†o trang & khi d·ªØ li·ªáu ngu·ªìn ƒë·ªïi
  flatten();
  window.addEventListener('storage', (e)=>{ if(e.key === SRC) flatten(); });

  // cho ph√©p g·ªçi th·ªß c√¥ng ngay sau khi t·∫°o ƒë∆°n (c√πng tab)
  window.BridgeOrders = { flattenNow: flatten };
})();
window.BridgeOrders?.flattenNow();
</script>

<script>
  // Khi Admin ƒë·ªïi tr·∫°ng th√°i: nghe chu√¥ng v√† render l·∫°i
  window.addEventListener('storage', function(e){
    if (e.key === 'orders.bump' || e.key === 'sv_orders_v1' || e.key === 'sv_orders_flat') {
      window.UserOrdersReload?.();
    }
  });
</script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
</body>
</html>
