<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Chi tiết sản phẩm</title>

    <!-- Vendor -->
    <link rel="stylesheet" href="/bootstrap-4.6.2-dist/css/bootstrap.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />

    <!-- Site CSS (ưu tiên base trước style) -->
    <link rel="stylesheet" href="/assets/css/base.css" />
    <link rel="stylesheet" href="/assets/css/style.css" />

    <style>
      :root {
        --pd-radius: 10px;
        --pd-shadow: 0 6px 18px rgba(0, 0, 0, 0.05);
        --pd-border: #e5e7eb;
        --pd-muted: #6b7280;
        --pd-primary: #0d6efd;
      }

      body {
        background: #f9fafb;
        font-family: "Segoe UI", Roboto, sans-serif;
      }
      .pd-wrap {
        padding: 24px 0 36px;
      }

      /* === Card chính === */
      .pd-card {
        background: #fff;
        border: 1px solid var(--pd-border);
        box-shadow: var(--pd-shadow);
        padding: 18px;
        border-radius: 10px;
      }
      .pd-title {
        font-size: 22px;
        font-weight: 700;
        line-height: 1.3;
        margin: 6px 0 10px;
      }
      .pd-meta {
        color: var(--pd-muted);
        font-size: 13px;
      }

      /* === Badge === */
      .pd-badges .pd-badge {
        display: inline-block;
        color: #fff;
        font-size: 11px;
        font-weight: 700;
        padding: 3px 8px;
        margin-right: 6px;
        border-radius: 6px;
      }
      .pd-badge.sale {
        background: #ef4444;
      }
      .pd-badge.new {
        background: #22c55e;
      }
      .pd-badge.oos {
        background: #6b7280;
      }

      /* === Giá === */
      .pd-price {
        display: flex;
        align-items: flex-end;
        gap: 8px;
        margin: 10px 0 6px;
        flex-wrap: wrap;
      }
      .pd-price .new {
        font-size: 24px;
        font-weight: 800;
        color: #111;
      }
      .pd-price .old {
        font-size: 14px;
        text-decoration: line-through;
        color: #9ca3af;
      }
      .pd-price .off {
        font-size: 12px;
        font-weight: 700;
        color: #ef4444;
        background: #fee2e2;
        padding: 2px 6px;
        border-radius: 6px;
      }

      /* Stock line */
      .pd-stock {
        font-size: 13px;
        color: #374151;
        margin-bottom: 10px;
      }

      /* === Mô tả & thông số === */
      .pd-short {
        color: #374151;
        font-size: 14px;
        line-height: 1.5;
      }
      .specs dt {
        font-weight: 600;
        font-size: 13px;
      }
      .specs dd {
        font-size: 13px;
        color: #374151;
      }

      /* === Gallery === */
      .gallery {
        display: grid;
        grid-template-columns: 80px 1fr;
        gap: 12px;
      }
      .gallery-main {
        border: 1px solid var(--pd-border);
        border-radius: 10px;
        background: #fff;
        overflow: hidden;
      }
      .gallery-main img {
        width: 100%;
        height: auto;
        display: block;
      }
      .gallery-thumbs {
        display: flex;
        flex-direction: column;
        gap: 8px;
        max-height: 400px;
        overflow: auto;
      }
      .gallery-thumbs img {
        width: 100%;
        aspect-ratio: 1/1;
        object-fit: cover;
        border: 1px solid var(--pd-border);
        border-radius: 8px;
        cursor: pointer;
        opacity: 0.8;
        transition: all 0.2s ease;
      }
      .gallery-thumbs img:hover {
        opacity: 1;
        transform: scale(1.03);
      }
      .gallery-thumbs img.active {
        border-color: var(--pd-primary);
        opacity: 1;
      }

      /* === Nút và hành động === */
      .pd-actions {
        display: flex;
        gap: 8px;
        align-items: center;
        margin-top: 14px;
        flex-wrap: wrap;
      }
      .pd-qty {
        width: 110px;
        font-size: 14px;
      }
      .pd-qty-hint {
        font-size: 12px;
        color: #6b7280;
      }
      .btn {
        font-size: 14px;
        border-radius: 6px;
      }

      /* === Chính sách & cam kết === */
      .pd-trust {
        display: flex;
        gap: 14px;
        flex-wrap: wrap;
        margin-top: 14px;
        color: var(--pd-muted);
        font-size: 13px;
      }
      .pd-trust i {
        margin-right: 5px;
      }

      /* === Sản phẩm liên quan === */
      .related-col {
        display: flex;
      }
      .related-card {
        display: flex;
        flex-direction: column;
        width: 100%;
        background: #fff;
        border: 1px solid var(--pd-border);
        border-radius: 10px;
        overflow: hidden;
        transition: all 0.15s ease;
      }
      .related-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--pd-shadow);
        border-color: #d1d5db;
      }
      .related-card .img-wrap {
        width: 100%;
        height: 180px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #fff;
        border-bottom: 1px solid var(--pd-border);
        padding: 8px;
      }
      .related-card .img-wrap img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
      }
      .related-body {
        padding: 8px 10px;
      }
      .related-name {
        font-size: 13.5px;
        color: #111;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .related-price {
        font-weight: 700;
        font-size: 14px;
        color: var(--pd-primary);
      }

      /* ===== BREADCRUMB ===== */
      .bread-crumb {
        padding: 10px 0;
        border-bottom: 1px solid #eee;
      }
      .bread-crumb .container {
        padding-left: 0;
        padding-right: 0;
      }
      .breadcrumb {
        list-style: none;
        margin: 0;
        padding: 0;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        line-height: 1.2;
        color: #6b7280;
        background: transparent !important;
      }
      @media (min-width: 768px) {
        .breadcrumb {
          font-size: 14px;
        }
      }
      .breadcrumb li {
        display: flex;
        align-items: center;
        color: #666;
      }
      .breadcrumb .sep {
        color: #9aa3ae;
        display: inline-flex;
        align-items: center;
      }
      .breadcrumb .sep i {
        font-size: 12px;
        line-height: 1;
        margin: 0 2px;
      }
      .breadcrumb a {
        color: #111;
        text-decoration: none !important;
        transition: opacity 0.2s ease;
      }
      .breadcrumb a:hover {
        opacity: 0.85;
        text-decoration: none !important;
      }
      .breadcrumb li strong span {
        color: #000;
        font-weight: 700;
        max-width: 100%;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        display: inline-block;
        vertical-align: bottom;
      }

      /* === Responsive === */
      @media (min-width: 992px) {
        #mainImg {
          width: 400px;
          height: 400px;
        }
        .pd-title {
          font-size: 26px;
        }
      }
      @media (max-width: 768px) {
        .gallery {
          grid-template-columns: 1fr;
          gap: 10px;
        }
        #mainImg {
          width: 100%;
          height: auto;
        }
        .related-card .img-wrap {
          height: 150px;
        }
      }

      /* ================== TABS ================== */
      .pd-card .nav-pills {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 14px;
        margin-bottom: 12px;
      }
      .pd-card .nav-pills .nav-link {
        padding: 8px 14px;
        font-weight: 600;
        font-size: 14px;
        color: #334155;
        background: #f1f5f9;
        border: 1px solid #e2e8f0;
        transition: 0.15s ease;
      }
      .pd-card .nav-pills .nav-link i {
        margin-right: 6px;
      }
      .pd-card .nav-pills .nav-link:hover {
        filter: brightness(0.98);
        transform: translateY(-1px);
      }
      .pd-card .nav-pills .nav-link.active {
        color: #fff;
        background: #2563eb;
        border-color: #2563eb;
        box-shadow: 0 6px 16px rgba(37, 99, 235, 0.22);
      }
      .pd-card .tab-content {
        background: #fff;
        border: 1px solid #e6e8ef;
        padding: 14px 16px;
      }
      .pd-card .tab-content .tab-pane {
        animation: pdFade 0.18s ease;
      }
      @keyframes pdFade {
        from {
          opacity: 0.6;
          transform: translateY(2px);
        }
        to {
          opacity: 1;
          transform: none;
        }
      }
      .pd-card .tab-content p,
      .pd-card .tab-content li {
        color: #334155;
        font-size: 14.5px;
        line-height: 1.65;
      }
      .pd-card .tab-content ul {
        padding-left: 18px;
        margin: 0;
      }
      .pd-card .tab-content ul li {
        margin-bottom: 6px;
      }
      .pd-card .tab-content ul li::marker {
        color: #2563eb;
      }
      .pd-card .tab-content ol {
        padding-left: 20px;
        margin: 0;
      }
      .pd-card .tab-content ol li {
        margin-bottom: 6px;
      }
      .pd-card .tab-content ol li::marker {
        color: #2563eb;
        font-weight: 700;
      }
      @media (max-width: 575.98px) {
        .pd-card .nav-pills {
          gap: 8px;
        }
        .pd-card .nav-pills .nav-link {
          padding: 8px 12px;
          font-size: 13.5px;
        }
        .pd-card .tab-content {
          padding: 12px;
        }
      }
    </style>
  </head>
  <body>
    <header class="header">
      <div class="topbar">
        <div class="container">
          <div class="topbar-right"></div>
        </div>
      </div>
    </header>

    <header class="mid-header">
      <div class="container">
        <div class="header-main">
          <div class="header-left">
            <form
              action="/search"
              method="get"
              class="search-bar"
              autocomplete="off"
            >
              <input
                type="text"
                name="query"
                placeholder="Tìm kiếm"
                autocomplete="off"
                autocapitalize="off"
                autocorrect="off"
                spellcheck="false"
                inputmode="search"
              />
              <button type="submit" aria-label="Tìm kiếm">
                <i class="fa-solid fa-magnifying-glass"></i>
              </button>
            </form>
          </div>

          <div class="header-center">
            <a href="/trangchu.html" class="logo">
              <img src="/assets/images/logo.jpg" alt="GENTLEMAN" />
            </a>
          </div>

          <div class="header-right">
            <a href="/giohang.html" class="cart-link">
              <i class="fa-solid fa-cart-shopping"></i>
              GIỎ HÀNG (<span class="cart-count">0</span>)
            </a>
          </div>
        </div>
      </div>
    </header>

    <nav class="main-nav">
      <ul>
        <li><a href="/trangchu.html">TRANG CHỦ</a></li>
        <li><a href="/gioithieu.html">GIỚI THIỆU</a></li>
        <li>
          <a href="/sanpham/sanpham.html" class="js-products-url">SẢN PHẨM</a>
        </li>
        <li><a href="/tintuc.html">TIN TỨC</a></li>
        <li><a href="/lienhe.html">LIÊN HỆ</a></li>
      </ul>
    </nav>

    <script>
      /* Điều hướng tìm kiếm sang trang sản phẩm và giữ đúng query */
      (function (w, d) {
        function getProductsURL() {
          var a =
            d.querySelector("nav.main-nav a.js-products-url") ||
            d.querySelector('nav.main-nav a[href*="/sanpham"]');
          return a && a.getAttribute("href")
            ? a.getAttribute("href")
            : "/sanpham/sanpham.html";
        }
        var form = d.querySelector(".search-bar");
        if (!form) return;

        form.addEventListener(
          "submit",
          function (e) {
            e.preventDefault();
            var input = form.querySelector(
              'input[name="query"], input[name="q"]'
            );
            var q = ((input && input.value) || "").trim().replace(/\s+/g, " ");
            var raw = getProductsURL();
            var url = new URL(raw, w.location.origin);
            if (q) url.searchParams.set("q", q);
            else url.searchParams.delete("q");
            w.location.href = url.pathname + (url.search ? url.search : "");
          },
          { passive: false }
        );
      })(window, document);
    </script>

    <script>
      /* Welcome name click → trang hồ sơ */
      (function (w, d) {
        function makeWelcomeClickable() {
          var el = d.querySelector(".welcome-user");
          if (el) {
            el.setAttribute("href", "/account/profile.html");
            return;
          }
          var target = d.querySelector(
            "#welcomeName, [data-welcome-name], .js-welcome-name"
          );
          if (!target) return;
          if (target.tagName !== "A") {
            var a = d.createElement("a");
            a.href = "/account/profile.html";
            a.className = "welcome-link";
            while (target.firstChild) a.appendChild(target.firstChild);
            target.appendChild(a);
          } else {
            target.setAttribute("href", "/account/profile.html");
          }
        }
        d.addEventListener("auth:ready", makeWelcomeClickable);
        if (w.AUTH && w.AUTH.ready) makeWelcomeClickable();
      })(window, document);
    </script>

    <div class="container pd-wrap">
      <!-- Breadcrumb 3 cấp -->
      <section class="bread-crumb">
        <div class="container">
          <ul class="breadcrumb">
            <li class="home">
              <a href="/trangchu.html"><span>Trang chủ</span></a>
            </li>
            <li class="sep"><i class="fa-solid fa-angle-right"></i></li>
            <li>
              <a href="/sanpham/pages/sanpham.html"><span>Sản phẩm</span></a>
            </li>
            <li class="sep"><i class="fa-solid fa-angle-right"></i></li>
            <li>
              <strong><span id="bc-name">Chi tiết</span></strong>
            </li>
          </ul>
        </div>
      </section>

      <div id="pd-root" class="row"><!-- JS render --></div>

      <hr />
      <h5 class="mb-3">Sản phẩm liên quan</h5>
      <div id="pd-related" class="row"></div>
    </div>

    <footer class="footer">
      <div class="site-footer">
        <div class="top-footer">
          <div class="container">
            <div class="row">
              <section class="widget-ft">
                <h4 class="title-menu">Thông tin</h4>
                <ul class="list-menu">
                  <li class="li_menu">
                    <a href="/trangchu.html">Trang chủ</a>
                  </li>
                  <li class="li_menu">
                    <a href="/gioithieu.html">Giới thiệu</a>
                  </li>
                  <li class="li_menu">
                    <a href="/sanpham/sanpham.html">Sản phẩm</a>
                  </li>
                  <li class="li_menu"><a href="/tintuc.html">Tin tức</a></li>
                  <li class="li_menu"><a href="/lienhe.html">Liên hệ</a></li>
                </ul>
              </section>

              <section class="widget-ft">
                <h4 class="title-menu">Hỗ trợ</h4>
                <ul class="list-menu">
                  <li class="li_menu">
                    <a href="/trangchu.html">Trang chủ</a>
                  </li>
                  <li class="li_menu">
                    <a href="/gioithieu.html">Giới thiệu</a>
                  </li>
                  <li class="li_menu">
                    <a href="/sanpham/sanpham.html">Sản phẩm</a>
                  </li>
                  <li class="li_menu"><a href="/tintuc.html">Tin tức</a></li>
                  <li class="li_menu"><a href="/lienhe.html">Liên hệ</a></li>
                </ul>
              </section>

              <section class="widget-ft">
                <h4 class="title-menu">Hướng dẫn</h4>
                <ul class="list-menu">
                  <li class="li_menu">
                    <a href="/trangchu.html">Trang chủ</a>
                  </li>
                  <li class="li_menu">
                    <a href="/gioithieu.html">Giới thiệu</a>
                  </li>
                  <li class="li_menu">
                    <a href="/sanpham/sanpham.html">Sản phẩm</a>
                  </li>
                  <li class="li_menu"><a href="/tintuc.html">Tin tức</a></li>
                  <li class="li_menu"><a href="/lienhe.html">Liên hệ</a></li>
                </ul>
              </section>

              <section class="widget-ft">
                <h4 class="title-menu">Chính sách</h4>
                <ul class="list-menu">
                  <li class="li_menu">
                    <a href="/trangchu.html">Trang chủ</a>
                  </li>
                  <li class="li_menu">
                    <a href="/gioithieu.html">Giới thiệu</a>
                  </li>
                  <li class="li_menu">
                    <a href="/sanpham/sanpham.html">Sản phẩm</a>
                  </li>
                  <li class="li_menu"><a href="/tintuc.html">Tin tức</a></li>
                  <li class="li_menu"><a href="/lienhe.html">Liên hệ</a></li>
                </ul>
              </section>

              <section class="wg-logo">
                <h4 class="title-menu">Liên hệ</h4>
                <ul class="contact">
                  <li>
                    <span class="txt_content_child">
                      <span
                        ><i
                          class="fa-solid fa-location-dot"
                          aria-hidden="true"
                        ></i
                      ></span>
                      140B-Tổ 3, Ấp Xóm Chùa,Tỉnh Tây Ninh
                    </span>
                  </li>
                  <li class="sdt">
                    <span
                      ><i class="fa-solid fa-phone" aria-hidden="true"></i
                    ></span>
                    <a href="tel:0338286525">0338286525</a>
                  </li>
                  <li class="sdt">
                    <span><i class="fa-solid fa-envelope"></i></span>
                    <a href="mailto:thanhloc29052006@gmail.com"
                      >thanhloc29052006@gmail.com</a
                    >
                  </li>
                </ul>
              </section>
            </div>
          </div>
        </div>

        <div class="mid-footer">
          <div class="container">
            <div class="row">
              <div class="fot_copyright">
                <span class="wsp"
                  ><span
                    >Cung cấp bởi <a href="javascript:;">Nhóm 7</a></span
                  ></span
                >
              </div>
              <nav class="fot_menu_copyright">
                <ul class="ul_menu_fot">
                  <li>
                    <a href="/trangchu.html" title="Trang chủ">Trang chủ</a>
                  </li>
                  <li>
                    <a href="/gioithieu.html" title="Giới thiệu">Giới thiệu</a>
                  </li>
                  <li>
                    <a href="/sanpham/sanpham.html" title="Sản phẩm"
                      >Sản phẩm</a
                    >
                  </li>
                  <li><a href="/tin-tuc" title="Tin tức">Tin tức</a></li>
                  <li><a href="/lienhe.html" title="Liên hệ">Liên hệ</a></li>
                </ul>
              </nav>
              <div class="pay_footer">
                <ul class="follow_option">
                  <li>
                    <a href="#"
                      ><img
                        src="//bizweb.dktcdn.net/100/004/366/themes/900241/assets/pay_1.png"
                        alt="Payment"
                    /></a>
                  </li>
                  <li>
                    <a href="#"
                      ><img
                        src="//bizweb.dktcdn.net/100/004/366/themes/900241/assets/pay_2.png"
                        alt="Payment"
                    /></a>
                  </li>
                  <li>
                    <a href="#"
                      ><img
                        src="//bizweb.dktcdn.net/100/004/366/themes/900241/assets/pay_3.png"
                        alt="Payment"
                    /></a>
                  </li>
                  <li>
                    <a href="#"
                      ><img
                        src="//bizweb.dktcdn.net/100/004/366/themes/900241/assets/pay_4.png"
                        alt="Payment"
                    /></a>
                  </li>
                  <li>
                    <a href="#"
                      ><img
                        src="//bizweb.dktcdn.net/100/004/366/themes/900241/assets/pay_5.png"
                        alt="Payment"
                    /></a>
                  </li>
                  <li>
                    <a href="#"
                      ><img
                        src="//bizweb.dktcdn.net/100/004/366/themes/900241/assets/pay_6.png"
                        alt="Payment"
                    /></a>
                  </li>
                  <li>
                    <a href="#"
                      ><img
                        src="//bizweb.dktcdn.net/100/004/366/themes/900241/assets/pay_7.png"
                        alt="Payment"
                    /></a>
                  </li>
                </ul>
              </div>
              <a
                href="#"
                id="back-to-top"
                class="backtop"
                title="Lên đầu trang"
              >
                <i class="fa-solid fa-angle-up" aria-hidden="true"></i>
              </a>
            </div>
          </div>
        </div>
      </div>
    </footer>

    <!-- Auth + Data + Store (đúng thứ tự) -->
    <script src="/assets/js/auth.js"></script>
    <script src="/assets/js/auth.modal.bridge.js"></script>

    <!-- Seed tĩnh -->
    <script src="/assets/js/products.seed.js"></script>

    <!-- Ưu tiên catalog đã export từ Admin -->
    <script>
      (function () {
        try {
          const fromAdmin = JSON.parse(
            localStorage.getItem("sv_products_v1") || "[]"
          );
          if (Array.isArray(fromAdmin) && fromAdmin.length) {
            window.SV_PRODUCT_SEED = fromAdmin;
          }
        } catch {}
      })();
    </script>

    <script src="/assets/js/store.js"></script>
    <script src="/assets/js/ui.js"></script>

    <!-- jQuery + Bootstrap JS -->
    <script
      src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"
      crossorigin="anonymous"
    ></script>

    <script>
      /* Module trang chi tiết sản phẩm */
      (function () {
        const Login = {
          URL: "/account/login.html",
          go() {
            const back = location.pathname + location.search + location.hash;
            location.href = this.URL + "?redirect=" + encodeURIComponent(back);
          },
        };

        const usp = new URLSearchParams(location.search);
        const id = usp.get("id") || "";

        const all =
          window.SVStore?.getAllProducts?.() || window.SV_PRODUCT_SEED || [];
        const fmt = window.SVStore?.fmtVND
          ? window.SVStore.fmtVND
          : (n) => Number(n || 0).toLocaleString("vi-VN") + "₫";

        const root = document.getElementById("pd-root");
        const bcName = document.getElementById("bc-name");

        function toSentenceCase(s = "") {
          s = String(s).trim();
          if (!s) return s;
          const low = s.toLowerCase();
          return low.charAt(0).toUpperCase() + low.slice(1);
        }
        function esc(s = "") {
          return String(s).replace(
            /[&<>\"']/g,
            (m) =>
              ({
                "&": "&amp;",
                "<": "&lt;",
                ">": "&gt;",
                '"': "&quot;",
                "'": "&#39;",
              }[m])
          );
        }
        function labelize(k) {
          return toSentenceCase(String(k).replace(/_/g, " ").trim());
        }
        function percentOff(p) {
          const a = Number(p?.original_price || 0),
            b = Number(p?.price || 0);
          if (!a || !b || b >= a) return 0;
          return Math.round((1 - b / a) * 100);
        }

        const p = all.find((x) => String(x.id) === String(id));
        if (!p) {
          root.innerHTML =
            '<div class="col-12"><div class="alert alert-warning">Không tìm thấy sản phẩm.</div></div>';
          return;
        }

        // Defaults
        p.unit =
          p.unit || (String(p.category || "").includes("wax") ? "hũ" : "chai");
        p.quantity = Number(p.quantity || 1);
        p.min_qty = Math.max(1, Number(p.min_qty || 1));
        p.max_qty = Math.max(p.min_qty, Number(p.max_qty || 99));
        p.stock = Number(p.stock ?? 0);

        // Tồn kho
        const effectiveMax = Math.max(0, Math.min(p.stock, p.max_qty));
        const isOOS =
          String(p.badge || "").toLowerCase() === "oos" ||
          String(p.badge || "").toLowerCase() === "out_of_stock" ||
          p.stock <= 0;

        // Breadcrumb
        bcName.textContent = toSentenceCase(p.name);

        const badge = String(p.badge || "").toLowerCase();
        const badgeHtml =
          badge === "sale"
            ? '<span class="pd-badge sale">Sale</span>'
            : badge === "new"
            ? '<span class="pd-badge new">Mới</span>'
            : isOOS
            ? '<span class="pd-badge oos">Hết hàng</span>'
            : "";

        const images =
          Array.isArray(p.images) && p.images.length
            ? p.images
            : [p.image].filter(Boolean);
        const firstImg = images[0] || "https://placehold.co/800x800/png";
        const off = percentOff(p);

        // Render
        root.innerHTML = `
    <div class="col-md-5">
      <div class="gallery">
        <div class="gallery-thumbs">
          ${images
            .map(
              (src, i) =>
                `<img ${i === 0 ? 'class="active"' : ""} data-src="${esc(
                  src
                )}" src="${esc(src)}" alt="${esc(toSentenceCase(p.name))}">`
            )
            .join("")}
        </div>
        <div class="gallery-main">
          <img id="mainImg" src="${esc(firstImg)}" alt="${esc(
          toSentenceCase(p.name)
        )}">
        </div>
      </div>
    </div>

    <div class="col-md-7">
      <div class="pd-card">
        <div class="mb-2 pd-badges">${badgeHtml}</div>
        <h1 class="pd-title">${esc(toSentenceCase(p.name))}</h1>
        <div class="pd-meta">Mã: ${esc(p.id)}</div>

        <div class="pd-price">
          <span class="new">${fmt(p.price)}</span>
          ${
            p.original_price
              ? `<span class="old">${fmt(p.original_price)}</span>`
              : ""
          }
          ${off > 0 ? `<span class="off">-${off}%</span>` : ""}
        </div>

        <div class="pd-stock">
          ${
            isOOS
              ? `<span class="text-danger"><i class="fa-regular fa-circle-xmark"></i> Hết hàng</span>`
              : `<span><i class="fa-regular fa-circle-check"></i> Còn ${
                  p.stock
                } ${esc(p.unit)}</span>`
          }
          ${
            p.rating
              ? ` &nbsp;|&nbsp; <i class="fa-solid fa-star"></i> ${Number(
                  p.rating
                ).toFixed(1)} (${p.reviews_count || 0} đánh giá)`
              : ""
          }
        </div>

        <div class="pd-short mb-2">${
          p.short_desc
            ? esc(toSentenceCase(p.short_desc))
            : p.description
            ? esc(toSentenceCase(p.description))
            : "Đang cập nhật mô tả..."
        }</div>

        ${renderSpecs(p)}

        ${renderTabs(p)}

        <div class="pd-actions">
          <div>
            <input id="qty" type="number"
                   class="form-control pd-qty"
                   value="${Math.min(
                     Math.max(p.quantity, p.min_qty),
                     effectiveMax || p.min_qty
                   )}"
                   min="${p.min_qty}" max="${Math.max(
          effectiveMax,
          p.min_qty
        )}" step="1"
                   ${isOOS ? "disabled" : ""}>
            <div id="qtyHint" class="pd-qty-hint">
              Đơn vị: ${esc(p.unit)} · Mua tối thiểu ${p.min_qty}${
          effectiveMax ? ` – tối đa ${effectiveMax}` : ""
        }.
            </div>
          </div>
          <button id="btnAdd" class="btn btn-primary" ${
            isOOS ? "disabled" : ""
          }>
            <i class="fas fa-cart-plus"></i> Thêm vào giỏ
          </button>
        </div>

        <div class="pd-trust">
          <span><i class="fa-regular fa-circle-check"></i> Hàng chính hãng</span>
          <span><i class="fa-regular fa-clock"></i> Đổi trả 7 ngày</span>
          <span><i class="fa-solid fa-truck"></i> Giao nhanh nội thành</span>
        </div>
      </div>
    </div>
  `;

        // Thumbs
        root.querySelectorAll(".gallery-thumbs img").forEach((t) => {
          t.addEventListener("click", () => {
            document.getElementById("mainImg").src = t.dataset.src;
            root
              .querySelectorAll(".gallery-thumbs img")
              .forEach((i) => i.classList.remove("active"));
            t.classList.add("active");
          });
        });

        // Số lượng
        const qtyEl = document.getElementById("qty");
        const hintEl = document.getElementById("qtyHint");
        function clampQty() {
          let v = Number(qtyEl.value || p.min_qty);
          if (Number.isNaN(v)) v = p.min_qty;
          if (effectiveMax > 0) v = Math.min(v, effectiveMax);
          v = Math.max(v, p.min_qty);
          qtyEl.value = v;
          hintEl.innerHTML =
            effectiveMax && v >= effectiveMax
              ? `Đơn vị: ${esc(p.unit)} · Tối đa ${effectiveMax} theo tồn kho.`
              : `Đơn vị: ${esc(p.unit)} · Mua tối thiểu ${p.min_qty}${
                  effectiveMax ? ` – tối đa ${effectiveMax}` : ""
                }.`;
        }
        qtyEl?.addEventListener("change", clampQty);
        qtyEl?.addEventListener("input", clampQty);

        // Add to cart (ép login)
        document.getElementById("btnAdd")?.addEventListener("click", () => {
          if (!window.AUTH?.loggedIn) {
            alert("Vui lòng đăng nhập để thêm sản phẩm vào giỏ hàng!");
            Login.go();
            return;
          }
          clampQty();
          const qty = Math.max(
            1,
            Number(document.getElementById("qty").value) || 1
          );
          if (effectiveMax && qty > effectiveMax) {
            alert(`Số lượng tối đa cho sản phẩm này là ${effectiveMax}.`);
            return;
          }

          if (window.SVStore?.addToCart) {
            window.SVStore.addToCart(p.id, qty);
          } else {
            try {
              const KEY = "sv_cart_v1";
              const cart = JSON.parse(localStorage.getItem(KEY) || "[]");
              const i = cart.findIndex((x) => x.id === p.id);
              const newQty = (i >= 0 ? cart[i].qty || 0 : 0) + qty;
              if (effectiveMax && newQty > effectiveMax) {
                alert(`Giới hạn ${effectiveMax} ${p.unit} cho sản phẩm này.`);
                return;
              }
              if (i >= 0) cart[i].qty = newQty;
              else cart.push({ id: p.id, qty });
              localStorage.setItem(KEY, JSON.stringify(cart));
            } catch {}
          }

          window.dispatchEvent(new CustomEvent("cart:changed"));
          window.SVUI?.updateCartCount?.();

          const btn = document.getElementById("btnAdd");
          const prev = btn.innerHTML;
          btn.disabled = true;
          btn.innerHTML = '<i class="fas fa-check"></i> Đã thêm';
          setTimeout(() => {
            btn.disabled = false;
            btn.innerHTML = prev;
          }, 900);
        });

        // Related
        const related = all
          .filter(
            (x) => x.category === p.category && String(x.id) !== String(p.id)
          )
          .slice(0, 3);
        document.getElementById("pd-related").innerHTML = related
          .map(
            (r) => `
    <div class="col-6 col-md-4 related-col">
      <a href="/sanpham/pages/product_detail.html?id=${encodeURIComponent(
        r.id
      )}" class="related-card text-reset">
        <div class="img-wrap"><img src="${esc(
          r.image || "https://placehold.co/600x600/png"
        )}" alt="${esc(toSentenceCase(r.name))}"></div>
        <div class="related-body">
          <div class="related-name">${esc(toSentenceCase(r.name))}</div>
          <div class="related-price">${fmt(r.price)}</div>
        </div>
      </a>
    </div>
  `
          )
          .join("");

        function renderSpecs(prod) {
          const specs = prod.specs || {};
          const keys = Object.keys(specs);
          if (!keys.length) return "";
          return `
      <h6 class="mt-3">Thông số</h6>
      <dl class="row specs">
        ${keys
          .map(
            (k) => `
          <dt class="col-sm-4">${esc(labelize(k))}</dt>
          <dd class="col-sm-8">${esc(String(specs[k]))}</dd>
        `
          )
          .join("")}
      </dl>
    `;
        }

        function renderTabs(prod) {
          const hasDetails = Array.isArray(prod.details) && prod.details.length;
          const hasUsage = Array.isArray(prod.usage) && prod.usage.length;
          const longDesc = prod.long_desc
            ? `<p>${esc(prod.long_desc)}</p>`
            : "";

          const detailsHTML = hasDetails
            ? `<ul>${prod.details
                .map((d) => `<li>${esc(d)}</li>`)
                .join("")}</ul>`
            : longDesc || "<p>Đang cập nhật nội dung chi tiết…</p>";

          const usageHTML = hasUsage
            ? `<ol>${prod.usage.map((u) => `<li>${esc(u)}</li>`).join("")}</ol>`
            : "<p>Đang cập nhật hướng dẫn sử dụng…</p>";

          return `
      <hr/>
      <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
        <li class="nav-item" role="presentation">
          <a class="nav-link active" id="pills-details-tab" data-toggle="pill" href="#pills-details" role="tab" aria-controls="pills-details" aria-selected="true">
            <i class="fa-regular fa-file-lines"></i> Chi tiết
          </a>
        </li>
        <li class="nav-item" role="presentation">
          <a class="nav-link" id="pills-usage-tab" data-toggle="pill" href="#pills-usage" role="tab" aria-controls="pills-usage" aria-selected="false">
            <i class="fa-solid fa-list-check"></i> Hướng dẫn sử dụng
          </a>
        </li>
      </ul>
      <div class="tab-content" id="pills-tabContent">
        <div class="tab-pane fade show active" id="pills-details" role="tabpanel" aria-labelledby="pills-details-tab">
          ${detailsHTML}
        </div>
        <div class="tab-pane fade" id="pills-usage" role="tabpanel" aria-labelledby="pills-usage-tab">
          ${usageHTML}
        </div>
      </div>
    `;
        }

        // Đồng bộ badge giỏ
        window.addEventListener("storage", (e) => {
          if (e.key && e.key.startsWith("sv_cart"))
            window.SVUI?.updateCartCount?.();
        });
        window.addEventListener("cart:changed", () =>
          window.SVUI?.updateCartCount?.()
        );
        document.addEventListener("DOMContentLoaded", () =>
          window.SVUI?.updateCartCount?.()
        );
      })();
    </script>

    <script>
      /* Tự refresh khi Admin cập nhật catalog */
      (function () {
        let tm = null;
        function scheduleRefresh() {
          if (tm) return; // chống spam
          tm = setTimeout(() => {
            tm = null;
            try {
              if (window.SVUI && typeof SVUI.renderProducts === "function") {
                SVUI.renderProducts();
                return;
              }
              if (typeof window.render === "function") {
                window.render();
                return;
              }
              if (
                window.SVProductDetail &&
                typeof SVProductDetail.render === "function"
              ) {
                SVProductDetail.render();
                return;
              }
            } catch (e) {
              console.warn("refresh error:", e);
            }
            try {
              location.reload();
            } catch {}
          }, 120);
        }

        window.addEventListener("storage", (e) => {
          if (!e || !e.key) return;
          if (
            e.key === "SV_PRODUCTS" ||
            e.key === "sv_products_v1" ||
            e.key === "SV_PRODUCTS_UPDATED_AT" ||
            e.key === "catalog.bump" /* <-- quan trọng */
          ) {
            scheduleRefresh();
          }
        });
      })();
    </script>
    <!-- cuối body, sau các script khác -->
    <script src="/assets/js/auth.kick.guard.js"></script>
  </body>
</html>
