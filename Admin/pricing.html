<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Quản lý giá bán | Nobility 1800s Admin</title>
  <link rel="stylesheet" href="./assets/css/style.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- GUARD -->
  <script>
    (function(){
      try{
        const u = JSON.parse(sessionStorage.getItem('session.user')||'null');
        if(!u || u.role!=='admin') location.replace('./login.html');
      }catch{ location.replace('./login.html'); }
    })();
  </script>

  <style>
    .page-header{display:flex;align-items:center;justify-content:space-between;margin:8px 0 16px}
    .page-header h1{font-size:20px;margin:0}
    .toolbar{display:flex;gap:8px;align-items:center;margin:12px 0;flex-wrap:wrap}
    .input{border:1px solid #e5e7eb;border-radius:10px;padding:10px 12px;min-width:220px;background:#fff}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid #e5e7eb;border-radius:10px;padding:10px 12px;background:#fff;font-weight:700;cursor:pointer}
    .btn.primary{background:#111;color:#fff;border-color:#111}
    .btn.ghost{background:#fff}
    table{width:100%;border-collapse:collapse;background:#fff;border-radius:14px;overflow:hidden}
    thead td{background:#f8fafc;font-weight:800;color:#111;border-bottom:1px solid #e5e7eb}
    td{padding:12px;border-bottom:1px solid #f0f2f5;vertical-align:middle}
    tr:hover{background:#fafafa}
    .num{text-align:right}
    .chip{display:inline-block;border:1px solid #e5e7eb;border-radius:999px;padding:2px 8px;font-size:12px}
    .status{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid #e5e7eb}
    .status.active{background:#ecfdf5;border-color:#a7f3d0;color:#065f46}
    .status.stopped{background:#fef2f2;border-color:#fecaca;color:#991b1b}
    .small{font-size:12px;color:#6b7280}
    .cell-input{display:flex;gap:6px;align-items:center;justify-content:flex-end}
    .cell-input input{width:110px;text-align:right;border:1px solid #e5e7eb;border-radius:8px;padding:8px 10px}
    .right{margin-left:auto}
  </style>
</head>
<body>
  <div class="container">
    <div class="navagation">
      <ul>
        <li><a href="./index.html"><span class="icon"><ion-icon name="logo-apple"></ion-icon></span><span class="title">Nobility 1800s</span></a></li>
        <li id="nav-dashboard"><a href="./index.html"><span class="icon"><ion-icon name="home-outline"></ion-icon></span><span class="title">Bảng điều khiển</span></a></li>
        <li id="nav-customers"><a href="./users.html"><span class="icon"><ion-icon name="people-outline"></ion-icon></span><span class="title">Quản lý khách hàng</span></a></li>
        <li id="nav-categories"><a href="./categories.html"><span class="icon"><ion-icon name="bookmarks-outline"></ion-icon></span><span class="title">Quản lý danh mục</span></a></li>
        <li id="nav-products"><a href="./products.html"><span class="icon"><ion-icon name="bag-remove-outline"></ion-icon></span><span class="title">Quản lý sản phẩm</span></a></li>
        <li id="nav-inventory"><a href="./inventory.html"><span class="icon"><ion-icon name="file-tray-stacked-outline"></ion-icon></span><span class="title">Quản lý hàng tồn kho</span></a></li>
        <li id="nav-pricing" class="hovered"><a href="./pricing.html"><span class="icon"><ion-icon name="pricetag-outline"></ion-icon></span><span class="title">Quản lý giá bán</span></a></li>
        <li id="nav-orders"><a href="./orders.html"><span class="icon"><ion-icon name="newspaper-outline"></ion-icon></span><span class="title">Quản lý đơn hàng</span></a></li>
        <hr/>
        <li><a href="#" id="btn-logout-side"><span class="icon"><ion-icon name="log-in-outline"></ion-icon></span><span class="title">Đăng xuất</span></a></li>
      </ul>
    </div>
  </div>

  <div class="main">
    <div class="topbar">
      <div class="toggle"><ion-icon name="menu-outline"></ion-icon></div>
      <div class="search">
        <label><input id="q" type="text" placeholder="Tìm theo mã / tên / nhà cung cấp..."/><ion-icon name="search-outline"></ion-icon></label>
      </div>
      <div class="user"><img src="./assets/img/user1.png" alt="user"/></div>
    </div>

    <div class="page-header">
      <h1>Quản lý giá bán</h1>
      <div class="right small" id="summary"></div>
    </div>

    <div class="toolbar">
      <select class="input" id="filter-cat"><option value="">— tất cả loại —</option></select>
      <select class="input" id="filter-status">
        <option value="">— mọi trạng thái —</option>
        <option value="selling">Đang bán</option>
        <option value="stopped">Hết bán</option>
        <option value="hidden">Ẩn</option>
      </select>

      <div class="chip">Sửa nhanh % lợi nhuận (áp cho danh sách đang lọc):</div>
      <input class="input" id="bulk-margin" type="number" step="0.1" placeholder="% lợi nhuận"/>
      <button class="btn" id="btn-apply-bulk"><i class="fa-solid fa-percent"></i> Áp dụng</button>
      <button class="btn ghost" id="btn-recalc"><i class="fa-solid fa-calculator"></i> Tính lại giá</button>
      <button class="btn primary" id="btn-save-all"><i class="fa-solid fa-floppy-disk"></i> Lưu tất cả</button>
    </div>

    <div class="details">
      <div class="recentOrders" style="flex:2">
        <table>
          <thead>
            <tr>
              <td>#</td>
              <td>Mã</td>
              <td>Tên sản phẩm</td>
              <td>Loại</td>
              <td class="num">Giá vốn</td>
              <td class="num">% LN</td>
              <td class="num">Giá bán</td>
              <td>Nhà cung cấp</td>
              <td>Trạng thái</td>
              <td>Thao tác</td>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Libs -->
  <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>

  <!-- App -->
<script src="../assets/js/products.seed.js"></script>
<script src="./assets/js/main.js"></script>
<script src="./assets/js/pricing.js"></script>
  <script>
    document.getElementById('btn-logout-side')?.addEventListener('click', (e)=>{
      e.preventDefault(); sessionStorage.removeItem('session.user'); location.href='./login.html';
    });
  </script>
  <script>
(function(){
const LS_USER = 'SV_PRODUCTS'; // User storefront đọc
const LS_ADMIN = 'sv_products_v1'; // Admin đang dùng


function emitUpdated(){
try{ localStorage.setItem('SV_PRODUCTS_UPDATED_AT', new Date().toISOString()); }catch(e){}
}


// Nếu đã có saveProds(list) thì quấn lại; nếu chưa có thì tạo mới
const originalSave = window.saveProds;
window.saveProds = function(list){
// Gọi hàm gốc (nếu tồn tại) để giữ logic cũ (format/validate...)
if (typeof originalSave === 'function') {
try { originalSave.call(this, list); } catch(e) { console.warn('saveProds original error:', e); }
}
// Ghi đồng thời 2 key để USER và ADMIN cùng nhìn 1 nguồn dữ liệu
try {
localStorage.setItem(LS_USER, JSON.stringify(list));
localStorage.setItem(LS_ADMIN, JSON.stringify(list));
} catch(e) { console.error('Cannot save products to localStorage:', e); }
// Phát tín hiệu để các tab USER render lại
emitUpdated();
// Cập nhật state.prods nếu tồn tại (tránh lệch)
try { if (window.state) window.state.prods = list; } catch {}
};
})();
</script>
</body>
</html>
