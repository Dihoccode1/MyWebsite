<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- GUARD: chưa đăng nhập admin -> quay về /Admin/login.html -->
    <script>
      (function () {
        try {
          const u = JSON.parse(
            sessionStorage.getItem("session.user") || "null"
          );
          if (!u || u.role !== "admin") location.replace("./login.html");
        } catch {
          location.replace("./login.html");
        }
      })();
    </script>

    <title>Quản lý người dùng | Nobility 1800s Admin</title>
    <!-- dùng đường dẫn TƯƠNG ĐỐI -->
    <link rel="stylesheet" href="./assets/css/style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <style>
      /* Fit với theme admin sẵn có */
      .page {
        padding: 14px 16px;
      }
      .page-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin: 0 0 12px;
      }
      .page-header h1 {
        font-size: 20px;
        margin: 0;
      }
      .actions {
        display: flex;
        gap: 8px;
      }
      .btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 10px 12px;
        background: #fff;
        cursor: pointer;
        font-weight: 700;
      }
      .btn.primary {
        background: #1f235a;
        color: #fff;
        border-color: #1f235a;
      }
      .btn.danger {
        background: #ef4444;
        color: #fff;
        border-color: #ef4444;
      }
      .btn.icon {
        padding: 8px 10px;
      }
      .toolbar {
        display: flex;
        gap: 10px;
        align-items: center;
        margin: 12px 0;
      }
      .input {
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 10px 12px;
        min-width: 240px;
        background: #fff;
        color: #111;
        outline: none;
      }
      .toolbar .input {
        min-width: 260px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        background: #fff;
        border-radius: 14px;
        overflow: hidden;
      }
      thead td {
        background: #f8fafc;
        font-weight: 800;
        color: #111;
        border-bottom: 1px solid #e5e7eb;
      }
      td {
        padding: 12px;
        border-bottom: 1px solid #f0f2f5;
        vertical-align: middle;
      }
      tr:hover {
        background: #fafafa;
      }
      .status {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 999px;
        font-size: 12px;
        border: 1px solid #e5e7eb;
      }
      .status.active {
        background: #ecfdf5;
        border-color: #a7f3d0;
        color: #065f46;
      }
      .status.locked {
        background: #fef2f2;
        border-color: #fecaca;
        color: #991b1b;
      }
      .chip {
        display: inline-block;
        border: 1px solid #e5e7eb;
        border-radius: 999px;
        padding: 2px 8px;
        font-size: 12px;
      }
      .empty {
        color: #9aa3ad;
        text-align: center;
        padding: 20px;
      }
      .modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.35);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 999;
      }
      .modal.show {
        display: flex;
      }
      .card {
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 16px;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.08);
        width: 100%;
        max-width: 720px;
      }
      .card .card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 14px 16px;
        border-bottom: 1px solid #eef2f7;
      }
      .card .card-body {
        padding: 16px;
      }
      .grid-2 {
        display: grid;
        grid-template-columns: 1fr;
        gap: 12px;
      }
      @media (min-width: 720px) {
        .grid-2 {
          grid-template-columns: 1fr 1fr;
        }
      }
      label.small {
        font-size: 12px;
        color: #6b7280;
        margin-bottom: 6px;
        display: block;
      }
      .muted {
        color: #6b7280;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- SIDEBAR -->
      <div class="navagation">
        <ul>
          <li>
            <a href="./index.html">
              <span class="icon"><ion-icon name="logo-apple"></ion-icon></span>
              <span class="title">Nobility 1800s</span>
            </a>
          </li>
          <li id="nav-dashboard">
            <a href="./index.html"
              ><span class="icon"
                ><ion-icon name="home-outline"></ion-icon></span
              ><span class="title">Bảng điều khiển</span></a
            >
          </li>
          <li class="hovered" id="nav-customers">
            <a href="./users.html"
              ><span class="icon"
                ><ion-icon name="people-outline"></ion-icon></span
              ><span class="title">Quản lý khách hàng</span></a
            >
          </li>
          <li id="nav-categories">
            <a href="./categories.html"
              ><span class="icon"
                ><ion-icon name="bookmarks-outline"></ion-icon></span
              ><span class="title">Quản lý danh mục</span></a
            >
          </li>
          <li id="nav-products">
            <a href="./products.html"
              ><span class="icon"
                ><ion-icon name="bag-remove-outline"></ion-icon></span
              ><span class="title">Quản lý sản phẩm</span></a
            >
          </li>
          <li id="nav-imports">
            <a href="./imports.html"
              ><span class="icon"
                ><ion-icon name="download-outline"></ion-icon></span
              ><span class="title">Phiếu nhập hàng</span></a
            >
          </li>
          <li id="nav-pricing">
            <a href="./pricing.html"
              ><span class="icon"
                ><ion-icon name="pricetag-outline"></ion-icon></span
              ><span class="title">Quản lý giá bán</span></a
            >
          </li>
          <li id="nav-inventory">
            <a href="./inventory.html"
              ><span class="icon"
                ><ion-icon name="file-tray-stacked-outline"></ion-icon></span
              ><span class="title">Quản lý hàng tồn kho</span></a
            >
          </li>
          <li id="nav-orders">
            <a href="./orders.html"
              ><span class="icon"
                ><ion-icon name="newspaper-outline"></ion-icon></span
              ><span class="title">Quản lý đơn hàng</span></a
            >
          </li>
          <hr />
          <!-- Chào mừng, Admin -->
          <li class="welcome-admin-tile" style="margin: 8px 10px 6px">
            <div
              style="
                display: flex;
                align-items: center;
                gap: 10px;
                padding: 10px 12px;
                border: 1px solid #2a2f8a;
                border-radius: 12px;
                background: #fff;
                color: #1f235a;
                font-weight: 700;
              "
            >
              <ion-icon name="person-circle-outline"></ion-icon
              ><span>Chào mừng, Admin</span>
            </div>
          </li>
          <li>
            <a href="#" id="btn-logout-side">
              <span class="icon"
                ><ion-icon name="log-in-outline"></ion-icon
              ></span>
              <span class="title">Đăng xuất</span>
            </a>
          </li>
        </ul>
      </div>
    </div>

    <div class="main">
      <!-- KHÔNG dùng topbar search ở trang này -->
      <div class="page">
        <div class="page-header">
          <h1>Quản lý người dùng</h1>
          <div class="actions">
            <button class="btn primary" id="btnAdd">
              <ion-icon name="person-add-outline"></ion-icon> Thêm tài khoản
            </button>
            <button class="btn" id="btnExport">
              <ion-icon name="download-outline"></ion-icon> Xuất JSON
            </button>
          </div>
        </div>

        <div class="toolbar">
          <input
            class="input"
            id="searchBox"
            placeholder="Tìm theo tên, email, SĐT..."
          />
          <select class="input" id="filterStatus" style="min-width: 160px">
            <option value="all">Tất cả trạng thái</option>
            <option value="active">Đang hoạt động</option>
            <option value="locked">Đã khóa</option>
          </select>
        </div>

        <table>
          <thead>
            <tr>
              <td>Họ tên</td>
              <td>Email</td>
              <td>SĐT</td>
              <td>Vai trò</td>
              <td>Trạng thái</td>
              <td>Tạo lúc</td>
              <td style="width: 260px">Thao tác</td>
            </tr>
          </thead>
          <tbody id="tbodyUsers">
            <tr>
              <td colspan="7" class="empty">Đang tải...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Modal: Add / Edit user -->
    <div class="modal" id="modalUser">
      <div class="card">
        <div class="card-header">
          <strong id="modalTitle">Thêm tài khoản</strong>
          <button class="btn icon" id="btnCloseModal" aria-label="Đóng">
            ✕
          </button>
        </div>
        <div class="card-body">
          <div class="grid-2">
            <div>
              <label class="small">Họ tên</label>
              <input class="input" id="uName" placeholder="Nguyễn Văn A" />
            </div>
            <div>
              <label class="small">Email</label>
              <input class="input" id="uEmail" placeholder="email@domain.com" />
            </div>
            <div>
              <label class="small">Số điện thoại</label>
              <input class="input" id="uPhone" placeholder="09xx..." />
            </div>
            <div>
              <label class="small">Địa chỉ</label>
              <input
                class="input"
                id="uAddress"
                placeholder="Địa chỉ giao hàng"
              />
            </div>
            <div>
              <label class="small">Mật khẩu</label>
              <input
                class="input"
                id="uPassword"
                placeholder="Mật khẩu khởi tạo"
                type="text"
              />
              <div class="muted" style="margin-top: 6px">
                Để trống nếu không muốn đổi mật khẩu khi sửa.
              </div>
            </div>
            <div>
              <label class="small">Vai trò</label>
              <select class="input" id="uRole">
                <option value="member">Member</option>
                <option value="admin">Admin</option>
              </select>
            </div>
          </div>
          <div
            style="
              display: flex;
              justify-content: flex-end;
              margin-top: 14px;
              gap: 8px;
            "
          >
            <button class="btn" id="btnCancel">Hủy</button>
            <button class="btn primary" id="btnSave">Lưu</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Ionicons -->
    <script
      type="module"
      src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"
    ></script>
    <script
      nomodule
      src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"
    ></script>

    <!-- JS chung của admin (toggle menu, active sidebar) -->
    <script src="./assets/js/main.js"></script>

    <!-- Logic Users (giữ nguyên của bạn, chỉ dời vào đây) -->
    <script>
      (function () {
        const LS_USERS = "sv_users_v1";
        const LS_PROFILES = "sv_profiles_v1";
        const BS_USERS = "bs_users";

        const $ = (s) => document.querySelector(s);
        const $$ = (s) => Array.from(document.querySelectorAll(s));

        function loadJSON(key, def) {
          try {
            return JSON.parse(localStorage.getItem(key) || JSON.stringify(def));
          } catch {
            return def;
          }
        }
        function saveJSON(key, val) {
          localStorage.setItem(key, JSON.stringify(val));
        }
        function fnv1a(s) {
          s = String(s || "");
          let h = 2166136261 >>> 0;
          for (let i = 0; i < s.length; i++) {
            h ^= s.charCodeAt(i);
            h = Math.imul(h, 16777619);
          }
          return (h >>> 0).toString(16);
        }
        function toast(msg) {
          alert(msg);
        }

        function getUsersMerged() {
          const sv = loadJSON(LS_USERS, []);
          const profiles = loadJSON(LS_PROFILES, {});
          const bs = loadJSON(BS_USERS, []);
          const map = new Map();

          sv.forEach((u) => {
            const key = (u.email || "").toLowerCase();
            map.set(key, {
              name: u.name || "",
              email: key,
              passHash: u.passHash || "",
              role: "member",
              status: u.status || "active",
              createdAt: u.createdAt || "",
              phone: profiles[key]?.phone || "",
              address: profiles[key]?.address || "",
            });
          });

          bs.forEach((u) => {
            const key = String(u.email || "").toLowerCase();
            const curr = map.get(key) || {};
            map.set(
              key,
              Object.assign(
                {
                  name: curr.name || u.fullName || u.username || key,
                  email: key,
                  passHash: curr.passHash || fnv1a(u.password || ""),
                  role: curr.role || u.role || "member",
                  status: curr.status || u.status || "active",
                  createdAt:
                    curr.createdAt || u.createdAt || new Date().toISOString(),
                  phone: curr.phone || u.phone || "",
                  address: curr.address || u.address || "",
                },
                curr
              )
            );
          });

          return Array.from(map.values()).sort((a, b) =>
            (b.createdAt || "").localeCompare(a.createdAt || "")
          );
        }

        function upsertUser({
          name,
          email,
          phone,
          address,
          password,
          role,
          status,
        }) {
          const emailLC = String(email || "").toLowerCase();
          if (!emailLC) throw new Error("Thiếu email");

          const sv = loadJSON(LS_USERS, []);
          const idx = sv.findIndex(
            (u) => String(u.email || "").toLowerCase() === emailLC
          );
          const base = {
            name: name || emailLC,
            email: emailLC,
            passHash: password ? fnv1a(password) : sv[idx]?.passHash || "",
            createdAt: sv[idx]?.createdAt || new Date().toISOString(),
            status: status || sv[idx]?.status || "active",
          };
          if (idx >= 0) sv[idx] = Object.assign({}, sv[idx], base);
          else sv.push(base);
          saveJSON(LS_USERS, sv);

          const profiles = loadJSON(LS_PROFILES, {});
          profiles[emailLC] = Object.assign({}, profiles[emailLC] || {}, {
            fullname: name || "",
            phone: phone || "",
            address: address || "",
          });
          saveJSON(LS_PROFILES, profiles);

          const bs = loadJSON(BS_USERS, []);
          const bidx = bs.findIndex(
            (u) => String(u.email || "").toLowerCase() === emailLC
          );
          const bBase = {
            id: bidx >= 0 ? bs[bidx].id : Date.now(),
            status: status || bs[bidx]?.status || "active",
            fullName: name || emailLC,
            username: emailLC,
            password: password ? String(password) : bs[bidx]?.password || "",
            email: emailLC,
            phone: phone || "",
            address: address || "",
            role: role || bs[bidx]?.role || "member",
            createdAt: bs[bidx]?.createdAt || new Date().toISOString(),
          };
          if (bidx >= 0) bs[bidx] = Object.assign({}, bs[bidx], bBase);
          else bs.push(bBase);
          saveJSON(BS_USERS, bs);
        }

        function setStatus(email, newStatus) {
          const emailLC = String(email || "").toLowerCase();
          const sv = loadJSON(LS_USERS, []);
          const idx = sv.findIndex(
            (u) => String(u.email || "").toLowerCase() === emailLC
          );
          if (idx >= 0) {
            sv[idx].status = newStatus;
            saveJSON(LS_USERS, sv);
          }
          const bs = loadJSON(BS_USERS, []);
          const bidx = bs.findIndex(
            (u) => String(u.email || "").toLowerCase() === emailLC
          );
          if (bidx >= 0) {
            bs[bidx].status = newStatus;
            saveJSON(BS_USERS, bs);
          }
        }
        function resetPassword(email, newPass) {
          const emailLC = String(email || "").toLowerCase();
          if (!newPass) throw new Error("Thiếu mật khẩu mới");
          const sv = loadJSON(LS_USERS, []);
          const idx = sv.findIndex(
            (u) => String(u.email || "").toLowerCase() === emailLC
          );
          if (idx >= 0) {
            sv[idx].passHash = fnv1a(newPass);
            saveJSON(LS_USERS, sv);
          }
          const bs = loadJSON(BS_USERS, []);
          const bidx = bs.findIndex(
            (u) => String(u.email || "").toLowerCase() === emailLC
          );
          if (bidx >= 0) {
            bs[bidx].password = String(newPass);
            saveJSON(BS_USERS, bs);
          }
        }

        const tbody = document.getElementById("tbodyUsers");
        const searchBox = document.getElementById("searchBox");
        const filterStatus = document.getElementById("filterStatus");

        function esc(s) {
          return String(s || "").replace(
            /[&<>"']/g,
            (m) =>
              ({
                "&": "&amp;",
                "<": "&lt;",
                ">": "&gt;",
                '"': "&quot;",
                "'": "&#39;",
              }[m])
          );
        }
        function formatDate(s) {
          const d = new Date(s || "");
          return isNaN(d) ? "—" : d.toLocaleString("vi-VN");
        }

        function render() {
          const q = (searchBox.value || "").trim().toLowerCase();
          const status = filterStatus.value;
          let list = getUsersMerged();
          if (q)
            list = list.filter((u) =>
              [u.name, u.email, u.phone].some((x) =>
                String(x || "")
                  .toLowerCase()
                  .includes(q)
              )
            );
          if (status !== "all")
            list = list.filter((u) => (u.status || "active") === status);

          if (!list.length) {
            tbody.innerHTML =
              '<tr><td colspan="7" class="empty">Không có dữ liệu</td></tr>';
            return;
          }

          tbody.innerHTML = list
            .map(
              (u) => `
        <tr>
          <td><strong>${esc(u.name || "")}</strong></td>
          <td>${esc(u.email || "")}</td>
          <td>${esc(u.phone || "")}</td>
          <td><span class="chip">${esc(u.role || "member")}</span></td>
          <td><span class="status ${
            u.status === "locked" ? "locked" : "active"
          }">${u.status === "locked" ? "Đã khóa" : "Đang hoạt động"}</span></td>
          <td>${formatDate(u.createdAt)}</td>
          <td>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn" title="Đổi mật khẩu" onclick="UsersUI.promptReset('${
                u.email
              }')">
                <i class="fa-solid fa-key"></i><span>Đổi mật khẩu</span>
              </button>
              ${
                u.status === "locked"
                  ? `<button class="btn" title="Mở khóa tài khoản" onclick="UsersUI.unlock('${u.email}')">
                     <i class="fa-solid fa-lock-open"></i><span>Mở khóa</span>
                   </button>`
                  : `<button class="btn" title="Khóa tài khoản" onclick="UsersUI.lock('${u.email}')">
                     <i class="fa-solid fa-lock"></i><span>Khóa tài khoản</span>
                   </button>`
              }
            </div>
          </td>
        </tr>`
            )
            .join("");
        }

        // search/filter
        searchBox.addEventListener("input", render);
        filterStatus.addEventListener("change", render);

        // Export
        document.getElementById("btnExport").addEventListener("click", () => {
          const data = { users: getUsersMerged() };
          const blob = new Blob([JSON.stringify(data, null, 2)], {
            type: "application/json",
          });
          const a = document.createElement("a");
          a.href = URL.createObjectURL(blob);
          a.download = "users-export.json";
          a.click();
        });

        // Modal
        const modal = document.getElementById("modalUser");
        const modalTitle = document.getElementById("modalTitle");
        const uName = $("#uName"),
          uEmail = $("#uEmail"),
          uPhone = $("#uPhone"),
          uAddress = $("#uAddress"),
          uPassword = $("#uPassword"),
          uRole = $("#uRole");

        function openModal() {
          modal.classList.add("show");
        }
        function closeModal() {
          modal.classList.remove("show");
        }
        document.getElementById("btnCloseModal").onclick = closeModal;
        document.getElementById("btnCancel").onclick = closeModal;

        document.getElementById("btnAdd").addEventListener("click", () => {
          modalTitle.textContent = "Thêm tài khoản";
          uName.value = "";
          uEmail.value = "";
          uPhone.value = "";
          uAddress.value = "";
          uPassword.value = "";
          uRole.value = "member";
          openModal();
        });

        document.getElementById("btnSave").addEventListener("click", () => {
          const name = uName.value.trim();
          const email = (uEmail.value || "").trim().toLowerCase();
          const phone = uPhone.value.trim();
          const address = uAddress.value.trim();
          const pass = uPassword.value;
          const role = uRole.value;
          if (!name || !email) return toast("Vui lòng nhập Họ tên và Email.");
          if (pass && pass.length < 4)
            return toast("Mật khẩu tối thiểu 4 ký tự.");
          try {
            upsertUser({
              name,
              email,
              phone,
              address,
              password: pass,
              role,
              status: "active",
            });
            closeModal();
            render();
            toast("Đã lưu tài khoản.");
          } catch (e) {
            toast(e.message || "Lỗi không xác định");
          }
        });

        // Actions expose
        window.UsersUI = {
          promptReset(email) {
            const newPass = prompt("Nhập mật khẩu mới cho " + email + ":");
            if (!newPass) return;
            if (newPass.length < 4) return toast("Mật khẩu tối thiểu 4 ký tự.");
            try {
              resetPassword(email, newPass);
              render();
              toast("Đã đặt lại mật khẩu.");
            } catch (e) {
              toast(e.message || "Lỗi");
            }
          },
          lock(email) {
            if (!confirm("Khóa tài khoản này?")) return;
            setStatus(email, "locked");
            render();
            toast("Đã khóa.");
          },
          unlock(email) {
            if (!confirm("Mở khóa tài khoản này?")) return;
            setStatus(email, "active");
            render();
            toast("Đã mở khóa.");
          },
        };

        // Đăng xuất sidebar
        document
          .getElementById("btn-logout-side")
          ?.addEventListener("click", (e) => {
            e.preventDefault();
            sessionStorage.removeItem("session.user");
            location.href = "./login.html";
          });

        // render lần đầu
        render();
      })();
    </script>
  </body>
</html>
